<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	    body, html{
            width:          100%;
            height:         100%;
            overflow:       hidden;
            margin:         0;
            font-family:    "微软雅黑";
        }
        #head{
            width: 100%;
            height: 7%;
        }
        #allmap{
            width:          100%;
            height:         93%;
        }
        #queryTime{
            float: left;
            padding-left: 200px;
            padding-top: 15px;
        }
	</style>
    <script type="text/javascript" src="../static/js/jquery.min.js" charset="UTF-8"></script>
    <!--引用百度地图相关文件-->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=eM0GfCwd27kZRyM49ZOkvkOaidDXz6Wf"></script>
    <!--加载鼠标绘制工具-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
	<!--加载检索信息窗口-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css" />
     <!--引用bootstrap和flat-ui样式及js文件-->
    <link rel="stylesheet" href="../static/css/bootstrap.css">
    <link rel="stylesheet" href="../static/css/flat-ui.css">
    <link rel="stylesheet" href="../static/css/bootstrap-datetimepicker.css">
    <script type="text/javascript" src="../static/js/bootstrap.js"></script>
    <script type="text/javascript" src="../static/js/flat-ui.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap-datetimepicker.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap-datetimepicker.zh-CN.js"  ></script>
    <!--加载区域边界数据信息-->
    <script type="text/javascript" src="../static/js/data.js"></script>
	<title>地图展示</title>
</head>

<body>
    <div id="head">
        <form class="form-inline" id="queryTime">
            <label>时间:</label>
            <input type="text" class="form-control form-date input-sm" value="2017-02-1 1:00:00" style="width: 180px;"  id="datetimepicker" data-date-format="yyyy-mm-dd hh:ii:ss">
            <button class="btn btn-primary btn-sm" onclick="queryTime()">查询</button>
        </form>
    </div>
    <div id="allmap"></div>
</body>
<script type="text/javascript">

	// 百度地图API功能
	var map = new BMap.Map("allmap");    // 创建Map实例
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 11);  // 初始化地图,设置中心点坐标和地图级别
	//map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
	map.setCurrentCity("北京");          // 设置地图显示的城市 此项是必须设置的
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);

     var styleOptions = {
        strokeColor:"red",    //边线颜色。
        fillColor:"red",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 3,       //边线的宽度，以像素为单位。
        strokeOpacity: 0.8,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.6,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid' //边线的样式，solid或dashed。
    }
    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(15, 15), //偏离值
        },
        circleOptions: styleOptions, //圆的样式
        polylineOptions: styleOptions, //线的样式
        polygonOptions: styleOptions, //多边形的样式
        rectangleOptions: styleOptions //矩形的样式
    });
    //添加鼠标绘制工具监听事件，用于获取绘制结果
    //drawingManager.addEventListener('overlaycomplete', overlaycomplete);

    //设置时间选择器
    $('#datetimepicker').datetimepicker({
        format: 'yyyy-mm-dd hh:ii:ss',
        language:'zh-CN',//设置日历为中文
        autoclose:1,
        minuteStep:10
    });

    //设置变量保存北京各区的id及区域颜色和区域标签文字
    var gradient = new gradientColor('#00FF00','#FF0000',300);//设置区域颜色的渐变色

    var district_ids = new Array();
    {% for district_id in district_ids %}
        district_ids.push({{ district_id }});
    {% endfor %}

    var region_colors = new Array();
    function get_region_color(region_id)
    {
        return region_colors[region_id];
    }
    var region_labels = new Array();
    function get_region_label(region_id)
    {
        return region_labels[region_id];
    }

    //点击查询按钮进行查询事件
    function queryTime() {
        //新建一个变量保存当前选择的时间
        var dateNow = $("#datetimepicker").val();
        alert(dateNow);
        //设置AJAX请求的默认参数选项
        $.ajaxSetup({
            //设置数据类型
            dataType: "json",
            //发送请求前触发
            beforeSend: function (xhr, settings) {
                //设置自定义请求表头
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
        });
        //返回其创建的 XMLHttpRequest 对象
        $.ajax({
            type: "POST",
            url: "{% url 'process:query_status' %}",//要求为String类型的参数，（默认为当前页地址）发送请求的地址
            data: {"query_dt":dateNow},//要求为Object或String类型的参数，发送到服务器的数据
            success: function (result) {
                //请求成功后返回一堆字符串，其中状态数据为0即表示返回数据符合要求
                if (result["code"] == 0) {
                    for(i=0;i<district_ids.length;i++)
                    {
                        //请求成功后返回各个区域的颜色和文字
                        var district_id = district_ids[i];
                        region_labels[district_id] = result["des"+district_id];
                        region_colors[district_id] = result[district_id];
                    }
                    //使用重新返回的文字和颜色重新画图
                    redraw();
            }
            else {
                alert(result.message);
            }
            },
            //请求失败调用函数，XMLHttpRequest对象、错误信息、捕获的错误对象
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });
    }

    //重新绘制覆盖物
    function redraw() {
        map.clearOverlays();//清除地图上所有覆盖物

        //每次循环都画一个区域
        for ( var region_id in data ){
            var points = [];  // 添加海量点数据

            for (var i = 0; i < data[region_id].length; i++) {
                //添加每个区域的边界地理点坐标
                points.push(new BMap.Point(data[region_id][i][0], data[region_id][i][1]));
            }
            var geo_center_point = new BMap.Point(geocenter[region_id][0],geocenter[region_id][1]);
            var marker = new BMap.Marker(geo_center_point);  // 创建地图上的图像标注
            map.addOverlay(marker);              // 将覆盖物添加到地图中

            //设置变量保存地图上的文本标注
            var label = new BMap.Label(get_region_label(region_id),{position :geo_center_point,offset   : new BMap.Size(20, -10)});
            label.setStyle({
                 color : "white",
                 fontSize : "12px",
                 border :"0",
                 backgroundColor :"0.0"
            });
            marker.setLabel(label);
            var polygon = new BMap.Polygon(points, { strokeColor:"#FFFFFF",fillColor:gradient[get_region_color(region_id)], strokeWeight:1, strokeOpacity:0.5});  // 初始化PointCollection
            map.addOverlay(polygon);
        }
    }

</script>

</html>