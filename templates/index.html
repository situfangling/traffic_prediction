{% extends "base.html" %}
{% load static from staticfiles %}
{% block title %}主页{% endblock %}
{% block head %}
<script type="text/javascript" src="{% static "js/data.js" %}"></script>
    <script>
        var gradient = new gradientColor('#00FF00','#FF0000',200);
        var district_ids = new Array();
        {% for district_id in district_ids %}
            district_ids.push({{ district_id }});
        {% endfor %}
        var region_colors = new Array();
        function get_region_color(region_id)
        {
            return region_colors[region_id];
        }
        var region_labels = new Array();
        function get_region_label(region_id)
        {
            return region_labels[region_id];
        }
        function query_datetime()
        {
            var dt_now = $("#datetimepicker").val();
            $.ajaxSetup({
                dataType: "json",
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
            });
            $.ajax({
                type: "POST",
                url: "{% url 'process:query_status' %}",
                data:{query_dt:dt_now},
                async: false,
                success: function (result) {
                    if (result["code"] == 0) {
                        for(i=0;i<district_ids.length;i++)
                        {
                            var district_id = district_ids[i];
                            region_labels[district_id] = result["des"+district_id];
                            region_colors[district_id] = result[district_id];
                        }
                        redraw_polygons();
                    }
                    else {
                        alert(result.message);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.table([{
                        "错误类型": jqXHR,
                        "错误信息": textStatus,
                        "http状态": errorThrown
                    }])
                }
            });
        }

        function handle_result_from_json(result) {

        }

        function select_an_area(now_overlay,points_list)
        {
            $.confirm({
                confirmButtonClass: 'btn-info',
                cancelButtonClass: 'btn-danger',

                keyboardEnabled: true,
                title: '信息',
                content: '是否选择当前区域中的数据点?',
                confirmButton: '是',
                cancelButton: '否',
                closeIcon: true,
                confirm: function () {

                    $.ajaxSetup({
                        dataType: "json",
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                        },
                    });

                    var json_points = JSON.stringify(points_list);
                    $.ajax({
                        type: "POST",
                        url: "{% url 'process:query_area' %}",
                        data: {point_list: json_points},
                        success: function (result) {
                            if (result.code == 0) {
                            handle_result_from_json(result);
                        }
                        else {
                            alert(result.message);
                        }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.table([{
                                "错误类型": jqXHR,
                                "错误信息": textStatus,
                                "http状态": errorThrown
                            }])
                        }
                    });
                    map.removeOverlay(now_overlay);
                },
                cancel: function () {
                    map.removeOverlay(now_overlay);
                }
            });
        }

    </script>
{% endblock %}
{% block content %}
    <div id="head">
        <div class="form-inline" id="queryTime" role="form">
            <label>时间:</label>
            <input type="text" class="form-control form-date input-sm" value="2017-04-1 18:00:00" style="width: 180px;"  id="datetimepicker" data-date-format="yyyy-mm-dd hh:ii:ss">
            <button class="btn btn-primary" onclick="query_datetime()">查询</button>&nbsp;
        </div>
    </div>
	<div id="allmap"></div>
{% endblock %}
{% block endscript %}
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("allmap");
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);     // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom();                        //启用滚轮放大缩小
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);
    map.enableKeyboard();

     var styleOptions = {
        strokeColor:"red",    //边线颜色。
        fillColor:"red",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 3,       //边线的宽度，以像素为单位。
        strokeOpacity: 0.8,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.6,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid' //边线的样式，solid或dashed。
    }
    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(15, 15), //偏离值
        },
        circleOptions: styleOptions, //圆的样式
        polylineOptions: styleOptions, //线的样式
        polygonOptions: styleOptions, //多边形的样式
        rectangleOptions: styleOptions //矩形的样式
    });
    var overlaycomplete = function(e){
        if (e.drawingMode=="polyline")//如果是画多边形结束后
        {
            var line_points = e.overlay.ia;
            poly_start_point=line_points[0];
            poly_end_point=line_points[line_points.length-1];
            distance_of_st=distance(poly_start_point,poly_end_point);
            threshold=0.0022;
            if (distance_of_st <= threshold)
            {

                now_overlay= e.overlay;
                select_an_area(now_overlay,line_points,modal_inner);
            }
            else {
                $.confirm({
                confirmButtonClass: 'btn-info',
                cancelButtonClass: 'btn-default',

                keyboardEnabled: true,
                title: '警告',
                content: '选择的区域起点和终点应相同,请重新绘制!',
                confirmButton: '确定',
                cancelButton: '取消',
                closeIcon: true,
                confirm: function () {
                    map.removeOverlay(e.overlay);
                },
                cancel: function () {
                    map.removeOverlay(e.overlay);
                }
            });
            }
        }
        if (e.drawingMode=="rectangle") {//画矩形结束
            var olRectPoint = e.overlay.getPath();
            /* *.Nk是从 e 的dom节点中寻找到的，百度本身没有提供此方法的介绍。
             * olRectPoint坐标排序方式
             *	┌─────────────────────┐
             *	│0					1 │
             *	│					  │
             *	│3					2 │
             *	└─────────────────────┘
             * */
            var sw = olRectPoint[0];		//左上
            var ne = olRectPoint[2];		//右下
            //alert('左上：'+ sw.lng+',' + sw.lat + '    右下：'+ne.lng+','+ne.lat);
            var line_points2=[sw,ne];
            var now_overlay= e.overlay;
            select_an_area(now_overlay,line_points2);
        }
    };

    //添加鼠标绘制工具监听事件，用于获取绘制结果
    drawingManager.addEventListener('overlaycomplete', overlaycomplete);
    $('#datetimepicker').datetimepicker({
        language:'zh-CN',
        autoclose:1,
        minuteStep:10});
    function redraw_polygons()
    {
        map.clearOverlays();
        for ( var region_id in data ){
            var points = [];  // 添加海量点数据
            for (var i = 0; i < data[region_id].length; i++) {
                points.push(new BMap.Point(data[region_id][i][0], data[region_id][i][1]));
            }
            var geo_center_point = new BMap.Point(geocenter[region_id][0],geocenter[region_id][1]);
            var marker = new BMap.Marker(geo_center_point);  // 创建标注
            map.addOverlay(marker);              // 将标注添加到地图中
            var label = new BMap.Label(get_region_label(region_id),{position :geo_center_point,offset   : new BMap.Size(20, -10)});
            label.setStyle({
                 color : "white",
                 fontSize : "12px",
                 border :"0",
                 backgroundColor :"0.0"
             });
            marker.setLabel(label);
            var polygon = new BMap.Polygon(points, { strokeColor:"#FFFFFF",fillColor:gradient[get_region_color(region_id)], strokeWeight:1, strokeOpacity:0.5});  // 初始化PointCollection
            map.addOverlay(polygon);
        }
    }

</script>
{% endblock %}